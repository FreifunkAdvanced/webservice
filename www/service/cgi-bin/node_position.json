#!/bin/sh -e

. /www/service/cgi-bin/common.sh

# try to get a lock within 3 seconds, get info without lock otherwise
exec 666>>/tmp/lock/geolocate
flock -w 3 -s 666 || true

uci batch <<EOF 2>&1 | tee /tmp/www.foo | {
get owm.settings.public
get owm.settings.lon
get owm.settings.lat
get owm.settings.postal_name
get owm.settings.postal_street
get owm.settings.postal_zip
get owm.settings.postal_city
get owm.settings.postal_country

EOF
    read_uci public
    read_uci lon
    read_uci lat
	read_uci name
	read_uci street
	read_uci zip
	read_uci city
	read_uci country

    if ! $public; then
	fail 403 'Geolokation deaktiviert'
    fi
    if [ -z "$lon" -o -z "$lat" ]; then
	fail 503 'Position noch nicht ermittelt'
    fi

    echo -e "Status: 200 OK\r
Content-Type: application/json\r
\r
{\"router_pos_lon\": $lon,
 \"router_pos_lat\": $lat,
 \"router_pos_name\": \"$name\",
 \"router_pos_street\": \"$street\",
 \"router_pos_zip\": \"$zip\",
 \"router_pos_city\": \"$city\",
 \"router_pos_county\": \"$county\"
}"
}